# iptables in Linux: A Comprehensive Guide

`iptables` is a command-line utility in Linux used to set up, maintain, and inspect the IP packet filter rules of the Linux kernel firewall. It determines how packets are handled at the system level based on user-defined rules.

---

### **Basic Syntax**

The general structure of an `iptables` command is as follows:

```bash
iptables -t [table] -[OPTIONS] [CHAIN] [matching components] [action/target]
```

1. **`-t [table]`**: Specifies the table (default is `filter`).
2. **`-[OPTIONS]`**: Defines the action on a chain or rule (e.g., `-A` to append a rule).
3. **`[CHAIN]`**: The chain to apply the rule (e.g., `INPUT`, `OUTPUT`).
4. **`[matching components]`**: Conditions to match packets (e.g., source IP, protocol).
5. **`[action/target]`**: Defines the action on matched packets (e.g., `ACCEPT`, `DROP`).

---

### **Tables in iptables**

`iptables` organizes rules into **tables**, each serving a specific purpose.

#### 1. **`filter` Table (Default)**

- Used for packet filtering (accept/drop traffic).
- Chains:
    - `INPUT`: For packets addressed to the host.
    - `FORWARD`: For packets routed through the host.
    - `OUTPUT`: For packets generated locally.
- Example:
    
    ```bash
    iptables -A INPUT -p tcp --dport 22 -j ACCEPT
    ```
    

#### 2. **`nat` Table**

- Used for network address translation.
- Chains:
    - `PREROUTING`: Alter packets before routing decisions.
    - `OUTPUT`: Alter locally-generated packets.
    - `POSTROUTING`: Alter packets before leaving the system.
- Example:
    
    ```bash
    iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080
    ```
    

#### 3. **`mangle` Table**

- Used for modifying packet headers (e.g., TOS, TTL).
- Example:
    
    ```bash
    iptables -t mangle -A PREROUTING -p tcp --dport 22 -j TOS --set-tos 0x10
    ```
    

#### 4. **`raw` Table**

- Used to exclude certain packets from connection tracking.
- Example:
    
    ```bash
    iptables -t raw -A PREROUTING -p tcp --dport 80 -j NOTRACK
    ```
    

#### 5. **`security` Table**

- Used for mandatory access control (e.g., SELinux).
- Example:
    
    ```bash
    iptables -t security -A INPUT -p tcp --dport 22 -j ACCEPT
    ```
    

---

### **Chains in iptables**

Chains are sets of rules that determine how packets are processed. Each chain corresponds to a specific packet processing stage:

1. **`PREROUTING`**: Used for incoming packets before routing decisions.
2. **`INPUT`**: Used for packets destined for the local machine.
3. **`FORWARD`**: Used for packets routed through the machine.
4. **`OUTPUT`**: Used for packets generated by the local machine.
5. **`POSTROUTING`**: Used for outgoing packets after routing decisions.

---

### **Options in iptables**

Options specify the operations to perform:

- **`-A` (Append)**: Add a rule to the end of a chain.
    
    ```bash
    iptables -A INPUT -p tcp --dport 80 -j ACCEPT
    ```
    
- **`-I` (Insert)**: Insert a rule at a specific position.
    
    ```bash
    iptables -I INPUT 1 -p tcp --dport 80 -j ACCEPT
    ```
    
- **`-D` (Delete)**: Remove a rule from a chain.
    
    ```bash
    iptables -D INPUT 1
    ```
    
- **`-F` (Flush)**: Remove all rules in a chain.
    
    ```bash
    iptables -F INPUT
    ```
    
- **`-L` (List)**: Display current rules.
    
    ```bash
    iptables -L -v --line-numbers
    ```
    
- **`-P` (Policy)**: Set the default policy for a chain.
    
    ```bash
    iptables -P INPUT DROP
    ```
    
- **`-t` (Table)**: Specify the table to use.
    
    ```bash
    iptables -t nat -L
    ```
    

---

### **Matching Components**

Matching components define conditions to filter packets.

#### **Generic Matches**

- `-p`: Protocol (e.g., `tcp`, `udp`, `icmp`).
    
    ```bash
    iptables -A INPUT -p tcp -j ACCEPT
    ```
    
- `-s`: Source IP address.
    
    ```bash
    iptables -A INPUT -s 192.168.1.1 -j DROP
    ```
    
- `-d`: Destination IP address.
    
    ```bash
    iptables -A INPUT -d 192.168.1.1 -j ACCEPT
    ```
    
- `-i`: Incoming network interface.
    
    ```bash
    iptables -A INPUT -i eth0 -j ACCEPT
    ```
    

#### **Implicit Matches**

- `--dport`: Destination port.
    
    ```bash
    iptables -A INPUT -p tcp --dport 80 -j ACCEPT
    ```
    
- `--sport`: Source port.
    
    ```bash
    iptables -A INPUT -p tcp --sport 8080 -j ACCEPT
    ```
    

#### **Explicit Matches**

- `-m`: Enables extended matching with modules (e.g., `limit`, `state`).
    
    ```bash
    iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
    ```
    

---

### **Action Components (Targets)**

Targets define actions for matching packets:

- **`ACCEPT`**: Allow the packet to pass.
    
    ```bash
    iptables -A INPUT -p tcp --dport 22 -j ACCEPT
    ```
    
- **`DROP`**: Silently discard the packet.
    
    ```bash
    iptables -A INPUT -p tcp --dport 23 -j DROP
    ```
    
- **`REJECT`**: Discard the packet and notify the sender.
    
    ```bash
    iptables -A INPUT -p tcp --dport 23 -j REJECT
    ```
    
- **`RETURN`**: Stop processing the current chain and return to the previous chain.
    

---

### **Examples**

1. **Allow SSH Traffic**
    
    ```bash
    iptables -A INPUT -p tcp --dport 22 -j ACCEPT
    ```
    
2. **Block Incoming HTTP Traffic**
    
    ```bash
    iptables -A INPUT -p tcp --dport 80 -j DROP
    ```
    
3. **Log Dropped Packets**
    
    ```bash
    iptables -A INPUT -j LOG --log-prefix "Dropped: "
    ```
    
4. **Allow Ping Requests**
    
    ```bash
    iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
    ```
    
5. **Set Default Policy to DROP**
    
    ```bash
    iptables -P INPUT DROP
    ```
    

