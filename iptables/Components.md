### **iptables: Tables, Chains, Matches, and Targets**

`iptables` is a foundational tool for managing Linux firewalls. It operates on a set of **tables**, **chains**, **matches**, and **targets**. This detailed guide explains each concept with examples.

---

### **1. Tables**

Tables define the _type of processing_ to be applied to packets. Each table serves a specific purpose and contains one or more chains. The default table is `filter`.

#### **a. `filter` Table**

- Purpose: Used for standard packet filtering (e.g., accepting or dropping traffic).
- Default chains:
    - `INPUT`: Incoming packets for the host.
    - `FORWARD`: Packets routed through the host.
    - `OUTPUT`: Packets generated by the host.
- Example:
    
    ```bash
    iptables -A INPUT -p tcp --dport 22 -j ACCEPT
    ```
    

#### **b. `nat` Table**

- Purpose: Handles Network Address Translation (NAT), commonly used for port forwarding and IP masquerading.
- Default chains:
    - `PREROUTING`: Modify packets before routing decisions.
    - `OUTPUT`: Modify locally generated packets.
    - `POSTROUTING`: Modify packets after routing decisions.
- Example (Redirect HTTP to another port):
    
    ```bash
    iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080
    ```
    

#### **c. `mangle` Table**

- Purpose: Alters packet headers (e.g., TOS, TTL).
- Default chains:
    - All five standard chains (`PREROUTING`, `INPUT`, `FORWARD`, `OUTPUT`, `POSTROUTING`).
- Example (Change TTL):
    
    ```bash
    iptables -t mangle -A OUTPUT -p tcp --dport 80 -j TTL --ttl-set 128
    ```
    

#### **d. `raw` Table**

- Purpose: Excludes packets from connection tracking.
- Default chains:
    - `PREROUTING`
    - `OUTPUT`
- Example:
    
    ```bash
    iptables -t raw -A PREROUTING -p tcp --dport 80 -j NOTRACK
    ```
    

#### **e. `security` Table**

- Purpose: Used for mandatory access control (e.g., SELinux rules).
- Default chains:
    - All five standard chains.
- Example:
    
    ```bash
    iptables -t security -A INPUT -p tcp --dport 22 -j ACCEPT
    ```
    

---

### **2. Chains**

Chains are rule sets that process packets. Each chain corresponds to a specific phase of packet traversal.

#### **Default Chains**

1. **`PREROUTING`**: Processes packets before routing.
2. **`INPUT`**: Processes packets addressed to the host.
3. **`FORWARD`**: Processes packets routed through the host.
4. **`OUTPUT`**: Processes packets generated by the host.
5. **`POSTROUTING`**: Processes packets after routing.

#### **Custom Chains**

- Users can create custom chains for organizing rules.
- Example (Create a custom chain):
    
    ```bash
    iptables -N LOGGING
    iptables -A INPUT -p tcp --dport 22 -j LOGGING
    iptables -A LOGGING -j LOG --log-prefix "SSH Access: "
    iptables -A LOGGING -j DROP
    ```
    

#### **Default Policies**

- Chains can have default policies to determine how unmatched packets are handled.
- Example (Set `INPUT` default to `DROP`):
    
    ```bash
    iptables -P INPUT DROP
    ```
    

---

### **3. Matches**

Matches define conditions that packets must meet for a rule to apply. They are the _criteria_ for filtering packets.

#### **Generic Matches**

- **Protocol (`-p`)**: Match packets based on protocol (e.g., `tcp`, `udp`, `icmp`).
    
    ```bash
    iptables -A INPUT -p tcp -j ACCEPT
    ```
    
- **Source IP (`-s`)**: Match packets from a specific source IP or subnet.
    
    ```bash
    iptables -A INPUT -s 192.168.1.0/24 -j ACCEPT
    ```
    
- **Destination IP (`-d`)**: Match packets to a specific destination IP.
    
    ```bash
    iptables -A INPUT -d 10.0.0.1 -j ACCEPT
    ```
    
- **Interfaces (`-i` and `-o`)**:
    
    - `-i`: Match incoming packets on a specific interface.
        
        ```bash
        iptables -A INPUT -i eth0 -j ACCEPT
        ```
        
    - `-o`: Match outgoing packets on a specific interface.
        
        ```bash
        iptables -A OUTPUT -o eth1 -j ACCEPT
        ```
        

#### **Implicit Matches**

- **Source Port (`--sport`)**: Match packets from a specific source port.
    
    ```bash
    iptables -A INPUT -p tcp --sport 80 -j ACCEPT
    ```
    
- **Destination Port (`--dport`)**: Match packets to a specific destination port.
    
    ```bash
    iptables -A INPUT -p tcp --dport 22 -j ACCEPT
    ```
    
- **TCP Flags (`--tcp-flags`)**: Match specific TCP flags.
    
    ```bash
    iptables -A INPUT -p tcp --tcp-flags SYN,ACK SYN -j ACCEPT
    ```
    

#### **Explicit Matches**

- Use the `-m` flag for additional matching modules.
    - **State (`state`)**:
        
        ```bash
        iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
        ```
        
    - **Limit (`limit`)**:
        
        ```bash
        iptables -A INPUT -p icmp -m limit --limit 5/min -j ACCEPT
        ```
        
    - **Multiport (`multiport`)**:
        
        ```bash
        iptables -A INPUT -p tcp -m multiport --dports 22,80,443 -j ACCEPT
        ```
        

---

### **4. Targets**

Targets specify actions to take when packets match a rule. The most common targets are **ACCEPT**, **DROP**, **REJECT**, and **RETURN**.

#### **Common Targets**

- **`ACCEPT`**: Allow the packet to pass.
    
    ```bash
    iptables -A INPUT -p tcp --dport 22 -j ACCEPT
    ```
    
- **`DROP`**: Silently discard the packet.
    
    ```bash
    iptables -A INPUT -p tcp --dport 23 -j DROP
    ```
    
- **`REJECT`**: Discard the packet and notify the sender.
    
    ```bash
    iptables -A INPUT -p tcp --dport 23 -j REJECT --reject-with icmp-port-unreachable
    ```
    
- **`LOG`**: Log the packet details for debugging.
    
    ```bash
    iptables -A INPUT -p tcp --dport 22 -j LOG --log-prefix "SSH: "
    ```
    
- **`RETURN`**: Stop processing current chain and return to the previous chain.
    
    ```bash
    iptables -A INPUT -p tcp --dport 80 -j RETURN
    ```
    

#### **Advanced Targets**

- **`SNAT`** (Source NAT): Used in `nat` table for altering source IP.
    
    ```bash
    iptables -t nat -A POSTROUTING -o eth0 -j SNAT --to-source 192.168.1.1
    ```
    
- **`DNAT`** (Destination NAT): Used for redirecting traffic.
    
    ```bash
    iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.2:8080
    ```
    
- **`MASQUERADE`**: Used for dynamic NAT in environments with dynamic IPs.
    
    ```bash
    iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
    ```
    

---

### **Examples: Combined Rules**

1. **Allow SSH and Ping, Block All Else**
    
    ```bash
    iptables -P INPUT DROP
    iptables -A INPUT -p tcp --dport 22 -j ACCEPT
    iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
    iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
    ```
    
2. **Port Forwarding** Forward HTTP traffic from port 80 to port 8080 on another server:
    
    ```bash
    iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:8080
    ```
    
3. **Rate-Limit ICMP Requests**
    
    ```bash
    iptables -A INPUT -p icmp -m limit --limit 10/second -j ACCEPT
    ```
    

---

This note provides a detailed overview of the **tables**, **chains**, **matches**, and **targets** in `iptables`, making it easier to create, manage, and debug firewall rules effectively.